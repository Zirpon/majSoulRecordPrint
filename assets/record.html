<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <style>
        body {
            font: 30px 'Helvetica Neue', Helvetica, Arial, sans-serif;
            color: #fcd409;
            /*
            min-width: 230px;
            max-width: 550px;
            line-height: 1.4em;   
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0 auto;
            font-weight: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh; 
            */
            background: linear-gradient(-135deg,#c850c0,#4158d0);
        }   
        #response-container {
            display: none;
            padding: 3rem;
            margin: 3rem 5rem;
            font-size: 120%;
            border: 5px dashed #ccc;
        }

        label {
            margin-left: 0.3rem;
            margin-right: 0.3rem;

            word-break: break-all;
            text-decoration: line-through;
            /***display: block;
            text-decoration: line-through;***/
        }
    </style>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <!-- Babel Script href="styles.css" -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@kunukn/react-collapse/dist/Collapse.umd.css"/>
    <script src="https://unpkg.com/@kunukn/react-collapse/dist/Collapse.umd.js"></script>
    <section class="logo">
        <img src="bg1.jpg" alt="maumaumau">
    </section>

    <h1>雀魂战绩 JS API Example</h1>
    <p id='pywebview-status'><i>pywebview</i> is not ready</p>

    <label id='majSoulID'><i>雀魂ID:</i></label><br/>
    <label id='majSoulName'><i>雀魂Name:</i></label><br/>

    <label for="nGame_input">查询场数:</label>
    <input id="majSoulGameN" value=60 onChange="setGameN()" style.width=10px
        type="text" placeholder="put a number here" autocomplete="on"><br/>
    
    <div id="buttons"></div>
    <script type="text/babel">
        window.addEventListener('pywebviewready', async function() {
            var container = document.getElementById('pywebview-status')
            container.innerHTML = '<i>pywebview</i> is ready'

            if (!localStorage.getItem('majSoulID') || !localStorage.getItem('majSoulName')) {
                //时序问题 顺序逻辑 但是此处的回调函数执行是异步的 
                //要么就在setcookie里直接设置innerhtml出来重复show也没什么问题
                pywebview.api.getIdName().then((response)=>{
                    if (!response || response == -1)
                        console.log("setting.json not found")
                    else if (response.err == -1)
                        console.log("setting.json formate error")
                    else if (response.err == 0) {
                        setCookies(response.id, response.name)
                    }
                })
            }
            //const sleep = (delay) => new Promise((resolve) => setTimeout(resolve, delay))
            //await sleep(1000);
            showCookies()
            if (localStorage.getItem('majSoulGameN'))
                document.getElementById('majSoulGameN').value = localStorage.getItem('majSoulGameN')
        })

        /////雀魂profile操作接口/////////////////////////////////////////////////////////
        function setGameN() {
            var majSoulGameN = document.getElementById('majSoulGameN').value;
            if (majSoulGameN)
                localStorage.setItem('majSoulGameN', majSoulGameN)
        }

        function setCookies(id ,name) {
            localStorage.setItem('majSoulID', id)
            localStorage.setItem('majSoulName', name)
            showCookies()
        }

        function showCookies() {
            document.getElementById('majSoulID').innerHTML = `<i>雀魂ID:</i>${localStorage.getItem('majSoulID')}`
            document.getElementById('majSoulName').innerHTML = `<i>雀魂Name:</i>${localStorage.getItem('majSoulName')}`
        }
        /////////////////////////////////////////////////////////////////////////////
        
        function get_cookies() {
            pywebview.api.get_cookies().then(showResponse)
        }

        /////雀魂战绩操作按钮///////////////////////////////////////////////////////////////
        function loadData() {
            pywebview.api.loadData().then(showResponse)
        }

        function printCountList() {
            var btn = document.getElementById('printCountList')
            pywebview.api.printCountList().then(showResponse)
        }

        function printCSV() {
            pywebview.api.printCSV().then(showResponse)
        }
        
        function GraphicCSV() {
            var majSoulGameN = document.getElementById('majSoulGameN').value;
            pywebview.api.graphicCSV(majSoulGameN).then(showResponse)
        }

        function CButton({btName,btFunc}) {
            const [n, setn] = React.useState(0);
            function handleClick() {
                btFunc();
                setn(n + 1);
            }
            return(<button type="checkbox" onClick={handleClick}>
                {btName}:({n})</button>)
        }

        function CButtonPage() {
            return(
                <div>
                <CButton btName="加载数据" btFunc={loadData} />
                <CButton btName="打印全部战绩数据" btFunc={printCountList} />
                <CButton btName="打印我的CSV战绩" btFunc={printCSV} />
                <CButton btName="战绩数据可视化图表" btFunc={GraphicCSV} />
                </div>
            )
        }
        const ddiv = document.getElementById("buttons");
        ReactDOM.render(<CButtonPage />, ddiv);
        
        ////操作结果显示提示框///////////////////////////////////////////////////////////////
        function showResponse(response) {
            const container = document.getElementById("WCollapse-innerText");
            container.innerText = response.message
        }

        ////responce block折叠///////////////////////////////////////////////////////////////
        function MCollapse(props) {
            const [isCollapsed, setIsCollapsed] = React.useState(props.collapsed);
            const style = {
                collapsed: {
                    display: "none"
                },
                expanded: {
                    display: "block"
                },
                buttonStyle: {
                display: "block",
                width: "100%"
                }
            };
            return (
                <div>
                    <button style={style.buttonStyle} onClick={()=>setIsCollapsed(!isCollapsed)}>
                        {isCollapsed ? "显示" : "隐藏"} 内容
                    </button>
                    <div
                        className="collapse-content"
                        style={isCollapsed ? style.collapsed : style.expanded}
                        // aria-expanded 是给 Screen Reader 用来 判断当前元素状态的辅助属性
                        aria-expanded={isCollapsed}
                    >
                        <div id="MCollapse-innerText"></div>
                    </div>
                </div>);
        }

        var WCollapse = window.Collapse;
        function WCollapseInst(){
            const [isOpenA, setIsOpenA] = React.useState(true);
            const [collapseHeight, setCollapseHeight] = React.useState("40px");
            const [duration, setDuration] = React.useState("100ms");
            const [isOpenC, setIsOpenC] = React.useState(false);
            const transitionStyle = { transitionDuration: "1s" };
            const [collapseStyle, setCollapseStyle] = React.useState(transitionStyle);

            function collapseA() {
                setIsOpenA(!isOpenA);
            }

            return(
                <div style={{display:"block"}}>
                    <div className={'column1'}>
                    {/*<span>动画时长500毫秒/折叠后高度40px:</span>*/}
                    <button onClick={collapseA} style={{width:"100%"}}>折叠/展开</button>
                    <WCollapse transition={`500ms`} collapseHeight={collapseHeight} isOpen={isOpenA}>
                        <div className={'collapseA'}>
                            <div id="WCollapse-innerText"></div>
                        </div>
                    </WCollapse>
                    </div>
                </div>)
        }

        //const ddiv3 = document.getElementById("ddddd");
        const ddiv2 = document.getElementById("response-container");
        ReactDOM.render(<WCollapseInst />, ddiv2);
        //ReactDOM.render(<MCollapse collapsed={false}/>, ddiv3);

    </script>
    <div id="response-container" style="display:block"></div>
    <!--div id="ddddd" style="display:block"></div-->
    <script>
    </script>
</body>
</html>
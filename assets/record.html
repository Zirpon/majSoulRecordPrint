<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <style>
        body {
            font: 30px 'Helvetica Neue', Helvetica, Arial, sans-serif;
            color: #fcd409;
            /*
            min-width: 230px;
            max-width: 550px;
            line-height: 1.4em;   
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0 auto;
            font-weight: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh; 
            */
            background: linear-gradient(-135deg,#c850c0,#4158d0);
        }   
        #response-container {
            display: none;
            padding: 3rem;
            margin: 3rem 5rem;
            font-size: 120%;
            border: 5px dashed #ccc;
        }

        label {
            margin-left: 0.3rem;
            margin-right: 0.3rem;

            word-break: break-all;
            text-decoration: line-through;
            /***display: block;
            text-decoration: line-through;***/
        }
    </style>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/c/font_3881267_wfv3iyzbijg.css">
</head>
<body>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <!-- Babel Script href="styles.css" -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@kunukn/react-collapse/dist/Collapse.umd.css"/>
    <script src="https://unpkg.com/@kunukn/react-collapse/dist/Collapse.umd.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/player/player.min.css" rel="stylesheet">

    <!--
    <script src="https://cdn.jsdelivr.net/npm/react-bootstrap@2.8.0/dist/react-bootstrap.min.js"></script>
    -->

    <script src="https://cdn.jsdelivr.net/npm/react-bootstrap-table-2@2.10.7/lib/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-bootstrap-table-next@4.0.3/dist/react-bootstrap-table-next.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@murasoftware/react-bootstrap-table2-filter@1.4.5/lib/index.min.js"></script>

    <!--section class="logo">
        <img src="bg1.jpg" alt="maumaumau">
    </section-->
    <!--轮播图 https://blog.csdn.net/m0_71734538/article/details/129100213 -->
    <section>
        <span class="left iconfont icon-anniu_jiantouxiangzuo"></span>
        <img src="./bg1.jpg" alt="" id="img">
        <span class="right iconfont icon-anniu-jiantouxiangyou"></span>
        <sliderp></sliderp>
    </section>
    <script src="./slider.js"></script>

    <h1>雀魂战绩 JS API Example</h1>
    <p id='pywebview-status'><i>pywebview</i> is not ready</p>
    <label id='majSoulID'><i>雀魂ID:</i> </label><br/>
    <label id='majSoulName'><i>雀魂Name:</i> </label><br/>

    <label for="nGame_input"><i>查询场数:</i> </label>
    <input id="majSoulGameN" value=60 onChange="setGameN()" style.width=10px
        type="text" placeholder="put a number here" autocomplete="on"><br/>
    
    <div id="appfff" style="display:block"></div>
    <div id="buttons"></div>

    <script type="text/babel">
        window.addEventListener('pywebviewready', async function() {
            var container = document.getElementById('pywebview-status')
            container.innerHTML = '<i>pywebview</i> is ready'

            if (!localStorage.getItem('majSoulID') || !localStorage.getItem('majSoulName')) {
                //时序问题 顺序逻辑 但是此处的回调函数执行是异步的 
                //要么就在setcookie里直接设置innerhtml出来重复show也没什么问题
                pywebview.api.getIdName().then((response)=>{
                    if (!response || response == -1)
                        console.log("setting.json not found")
                    else if (response.err == -1)
                        console.log("setting.json formate error")
                    else if (response.err == 0) {
                        setCookies(response.id, response.name)
                    }
                })
            }
            //const sleep = (delay) => new Promise((resolve) => setTimeout(resolve, delay))
            //await sleep(1000);
            showCookies()
            if (localStorage.getItem('majSoulGameN'))
                document.getElementById('majSoulGameN').value = localStorage.getItem('majSoulGameN')
        })

        /////雀魂profile操作接口/////////////////////////////////////////////////////////
        function setGameN() {
            var majSoulGameN = document.getElementById('majSoulGameN').value;
            if (majSoulGameN)
                localStorage.setItem('majSoulGameN', majSoulGameN)
        }

        function setCookies(id ,name) {
            localStorage.setItem('majSoulID', id)
            localStorage.setItem('majSoulName', name)
            showCookies()
        }

        function showCookies() {
            document.getElementById('majSoulID').innerHTML = `<i>雀魂ID:</i>${localStorage.getItem('majSoulID')}`
            document.getElementById('majSoulName').innerHTML = `<i>雀魂Name:</i>${localStorage.getItem('majSoulName')}`
        }
        /////////////////////////////////////////////////////////////////////////////
        
        function get_cookies() {
            pywebview.api.get_cookies().then(showResponse)
        }

        /////雀魂战绩操作按钮///////////////////////////////////////////////////////////////
        function loadData(nclick) {
            pywebview.api.loadData(nclick).then(
                (response)=>{
                    var csv = Papa.unparse(response.data);
                    showResponse(csv)
                }
            )
        }

        function printCountList(nclick) {
            pywebview.api.printCountList(nclick).then(showResponse)
        }

        function printCSV(nclick) {
            pywebview.api.printCSV(nclick).then(showResponse)
        }
        
        function graphicCSV(nclick) {
            var majSoulGameN = document.getElementById('majSoulGameN').value;
            showResponse({message:"请稍候..."})
            document.getElementById('loader').style.display = 'flex'
            pywebview.api.graphicCSV(nclick, majSoulGameN).then((response)=>{
                showResponse(response)
                document.getElementById('loader').style.display = 'none'}
            )
        }

        function resetFlag(nclick) {
            pywebview.api.resetFlag(nclick).then(showResponse)
        }

        function CButton({btName, btFunc, tmp=null}) {
            const [n, setn] = React.useState(0);
            function handleClick() {
                setn(n+1);
                if (btName === "reset") {
                    //setIntResetflag(tmp+1);
                    btFunc();
                    resetFlag(n)
                }
                else
                    btFunc(n+1);
            }
            
            React.useEffect(() => {
                    setn(0);
                    console.log(btName, tmp, n)
                }, [tmp]
            );

            return(<button type="checkbox" onClick={handleClick}>
                    {btName}:({n})</button>)
        }

        function CButtonPage() {      
            const [IntResetflag, setIntResetflag] = React.useState(0);     
            return(
                <div>
                <CButton btName="加载数据" btFunc={loadData} tmp={IntResetflag}/>
                <CButton btName="打印全部战绩数据" btFunc={printCountList} tmp={IntResetflag} />
                <CButton btName="打印我的CSV战绩" btFunc={printCSV} tmp={IntResetflag} />
                <CButton btName="战绩数据可视化图表" btFunc={graphicCSV} tmp={IntResetflag} />
                <CButton btName="reset" btFunc={()=>{
                        setIntResetflag(IntResetflag+1);
                    }} tmp={IntResetflag} />
                </div>
            )
        }
        const ddiv = document.getElementById("buttons");
        ReactDOM.render(<CButtonPage />, ddiv);
        
        ////操作结果显示提示框///////////////////////////////////////////////////////////////
        function showResponse(response) {
            const container = document.getElementById("WCollapse-innerText");
            container.innerText = response.message
        }

        ////responce block折叠///////////////////////////////////////////////////////////////
        function MCollapse(props) {
            const [isCollapsed, setIsCollapsed] = React.useState(props.collapsed);
            const style = {
                collapsed: {
                    display: "none"
                },
                expanded: {
                    display: "block"
                },
                buttonStyle: {
                display: "block",
                width: "100%"
                }
            };
            return (
                <div>
                    <button style={style.buttonStyle} onClick={()=>setIsCollapsed(!isCollapsed)}>
                        {isCollapsed ? "显示" : "隐藏"} 内容
                    </button>
                    <div
                        className="collapse-content"
                        style={isCollapsed ? style.collapsed : style.expanded}
                        // aria-expanded 是给 Screen Reader 用来 判断当前元素状态的辅助属性
                        aria-expanded={isCollapsed}
                    >
                        <div id="MCollapse-innerText"></div>
                    </div>
                </div>);
        }

        var WCollapse = window.Collapse;
        function WCollapseInst(){
            const [isOpenA, setIsOpenA] = React.useState(true);
            const [collapseHeight, setCollapseHeight] = React.useState("40px");
            const [duration, setDuration] = React.useState("100ms");
            const [isOpenC, setIsOpenC] = React.useState(false);
            const transitionStyle = { transitionDuration: "1s" };
            const [collapseStyle, setCollapseStyle] = React.useState(transitionStyle);

            function collapseA() {
                setIsOpenA(!isOpenA);
            }

            return(
                <div style={{display:"block"}}>
                    <div className={'column1'}>
                    {/*<span>动画时长500毫秒/折叠后高度40px:</span> style={{display:"none"}} */}
                    <button onClick={collapseA} style={{width:"100%"}}>折叠/展开</button>
                    <WCollapse transition={`500ms`} collapseHeight={collapseHeight} isOpen={isOpenA}>
                        <div className={'collapseA'}>
                            <div id="WCollapse-innerText"></div>
                            {/*js style 设置格式*/}
                            <div id="loader" className="loader" style={{display:'none'}}></div>
                        </div>
                    </WCollapse>
                    </div>
                </div>)
        }

        //const ddiv3 = document.getElementById("ddddd");
        const ddiv2 = document.getElementById("response-container");
        ReactDOM.render(<WCollapseInst />, ddiv2);
        //ReactDOM.render(<MCollapse collapsed={false}/>, ddiv3);
    </script>
    <div id="response-container" style="display:block"></div>
    <!--div id="ddddd" HTML stype设置格式 style="display:block"></div-->
</body>
</html>